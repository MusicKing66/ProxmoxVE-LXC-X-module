<script src="./plugins/servers/proxmoxlxc/templates/echarts.min.js" type="text/javascript" charset="utf-8"></script>

<style type="text/css" media="all">
  .border-left-warning {
    border-left: .25rem solid #f6c23e !important;
  }

  .border-left-info {
    border-left: .25rem solid #36b9cc !important;
  }

  .border-left-success {
    border-left: .25rem solid #1cc88a !important;
  }

  .border-left-primary {
    border-left: .25rem solid #4e73df !important;
  }

  .text-gray-300 {
    color: #dddfeb !important;
  }

  .shadow {
    box-shadow: 0 .15rem 1.75rem 0 rgba(58, 59, 69, .15) !important;
  }

  .fa-2x {
    font-size: 2em;
  }

  .no-gutters {
    margin-right: 0;
    margin-left: 0;
  }

  .card {
    margin-bottom: 0px;

  }
</style>
<!--<button type="button" class="btn btn-success sm-text text-uppercase mb-2" data-toggle="modal" data-target="#VNC">VNC</button>-->
<!-- æ‰§è¡Œä¸€æ¬¡POSTè¯·æ±‚ éšåæ‰“å¼€VNC-->

<!--ä½¿ç”¨æ¦‚æ‹¬-->
<div class="row">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">å¤„ç†å™¨ä½¿ç”¨ç‡</div>
            <div class="row no-gutters align-items-center">
              <div class="col">
                <div class="progress progress-sm mr-2">
                  <div class="progress-bar bg-primary" role="progressbar" id="cpu_jdt" style="width:0%"
                    aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

              </div>
            </div>
            <div class="h5 mt-1 font-weight-bold text-gray-800"><a id="cpu">0</a>% çš„ <a id="cpus">0</a> CPU(s)</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">å†…å­˜ä½¿ç”¨ç‡(<a id="mem_"></a>%)</div>
            <div class="row no-gutters align-items-center">
              <div class="col">
                <div class="progress progress-sm mr-2">
                  <div class="progress-bar bg-success" role="progressbar" id="mem_jdt" style="width: 0%"
                    aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

              </div>
            </div>
            <div class="h5 mt-1 font-weight-bold text-gray-800"><a id="max_mem">512.00</a> MiB</div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ç¡¬ç›˜å ç”¨ç‡(<a id="disk_"></a>%)</div>
            <div class="row no-gutters align-items-center">
              <div class="col">
                <div class="progress progress-sm mr-2">
                  <div class="progress-bar bg-info" role="progressbar" id="disk_jdt" style="width: 0%"
                    aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

              </div>
            </div>
            <div class="h5 mb-0 mt-1 font-weight-bold text-gray-800"><a id="min_disk"></a> / <a id="max_disk"></a> G
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">å·²æ­£å¸¸è¿è¡Œ</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800"><a id="run_time"></a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-danger shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">æµé‡ä½¿ç”¨</div>

            <div class="row no-gutters align-items-center mb-2">
              <div class="col">
                <div class="progress progress-sm mr-2">
                  <div class="progress-bar bg-danger" role="progressbar" id="traffic_bar" style="width: 0%"
                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="col-auto">
                <div class="small font-weight-bold text-gray-800"><a id="traffic_percent">0</a>%</div>
              </div>
            </div>

            <div class="h6 mb-1 font-weight-bold text-gray-800">
              ä¸Šä¼ ï¼š<a id="traffic_tx">0</a> GB<br>
              ä¸‹è½½ï¼š<a id="traffic_rx">0</a> GB<br>
              æ€»è®¡ï¼š<a id="traffic_total">0</a> GB / <a id="traffic_limit">0</a> GB
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!--ä½¿ç”¨æ¦‚æ‹¬ç»“æŸ-->


<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">PVEæ§åˆ¶å°</h6>
  </div>
  <div class="card-body">
    <p>ä½¿ç”¨ ProxmoxVE æ§åˆ¶é¢æ¿æ“ä½œæ‚¨çš„æœåŠ¡å™¨</p>
    <p class="mb-2 text-danger font-weight-bold">
      âš ï¸ SSH å¯èƒ½æœªå¯ç”¨ï¼Œå¦‚æ— æ³•è¿æ¥ï¼Œè¯·é€šè¿‡æœ¬æ§åˆ¶é¢æ¿çš„ <b>VNC æ§åˆ¶å°</b> è¿›å…¥å®¹å™¨ï¼Œæ‰‹åŠ¨å¼€å¯ SSH æœåŠ¡
    </p>
    <p class="mb-0">
      VMIDï¼š<a id="vmid">{$params['domain']}</a><br>
      User nameï¼š<a id="username_vnc">{$params['dedicatedip']}</a><br>
      Passwordï¼š<a id="password_vnc">{$params['password']}</a><br>
      Realmï¼š<span>Proxmox VE authentication server</span><br>
      æ§åˆ¶é¢æ¿ï¼š<a id="url_vnc" href="{$params['server_http_prefix']}://{$params['server_ip']}:{$params['port']}"
        target="_blank">
        {$params['server_http_prefix']}://{$params['server_ip']}:{$params['port']}
      </a>
    </p>
    <hr>
    <button class="btn btn-sm btn-primary mt-2" onclick="copySSHCommand()">ğŸ“‹ ä¸€é”®å¤åˆ¶å¼€å¯ root SSH å‘½ä»¤</button>
    <p id="copyStatus" class="mt-2 text-success" style="display:none;">âœ… å‘½ä»¤å·²å¤åˆ¶ï¼è¯·ç™»å½• PVE æ§åˆ¶å°ç²˜è´´æ‰§è¡Œ</p>
  </div>
</div>


<script type="text/javascript" charset="utf-8">


  // è¯·æ±‚åç«¯è·å–ä½¿ç”¨æ¦‚å†µ

  current = setInterval(() => {
    get_current()
    get_traffic();
  }, 1000)//2ç§’æŸ¥ä¸€ä¸‹

  function get_current() {

    var body = { "func": "Getcurrent" }
    $.post("{$MODULE_CUSTOM_API}", body, function (data, status) {

      // CPUä½¿ç”¨ç‡
      var cpu_b = Math.round(data.data.cpu.toString().substring(0, 4) * 100)
      cpus.innerHTML = data.data.cpus
      cpu_jdt.style = "width:" + cpu_b + "%"
      cpu.innerHTML = cpu_b

      // å†…å­˜ä½¿ç”¨ç‡
      var run_mem = (data.data.mem / 1024) / 1024
      var mem_max = (data.data.maxmem / 1024) / 1024
      max_mem.innerHTML = Math.round(run_mem) + "MiB /" + mem_max
      mem_jdt.style = "width:" + Math.round(run_mem / mem_max * 100) + "%"
      mem_.innerHTML = Math.round(run_mem / mem_max * 100)

      // ç£ç›˜ä½¿ç”¨ç‡
      var maxdisk = Math.round((data.data.maxdisk / 1024) / 1024 / 1024)



      var w_disk = Math.round(((data.data.disk) / 1024) / 1024)

      if (w_disk > 4096) {
        // æ•°é‡å¤ªå¤§ è½¬GBæ ¼å¼
        min_disk.innerHTML = w_disk / 1024 + "G"

      } else {
        min_disk.innerHTML = w_disk + "M"

      }
      max_disk.innerHTML = maxdisk
      disk_jdt.style = "width:" + Math.round(w_disk / 1024 / maxdisk * 100) + "%"
      disk_.innerHTML = Math.round(w_disk / 1024 / maxdisk * 100)

      // è¿è¡Œæ—¶é—´

      if (data.data.uptime > 86400) {
        run_time.innerHTML = Math.round(data.data.uptime / 60 / 60 / 24) + " å¤©"
      } else if (data.data.uptime < 3600) {
        run_time.innerHTML = Math.round(data.data.uptime / 60) + " åˆ†é’Ÿ"
      }

      else {
        run_time.innerHTML = Math.round(data.data.uptime / 60 / 60) + " å°æ—¶"
      }
      // console.log(maxdisk)
    })
  }


  function get_traffic() {
    var body = { func: "GetTraffic", vmid: $("#vmid").text() };

    $.post("{$MODULE_CUSTOM_API}", body, function (data, status) {
      if (!data || !data.data) return;

      let tx = (data.data.tx / 1073741824).toFixed(2); // ä¸Šä¼  GB
      let rx = (data.data.rx / 1073741824).toFixed(2); // ä¸‹è½½ GB
      let total = (data.data.month_used / 1073741824).toFixed(2); // æ€»ç”¨ GB
      let limit = (data.data.data_limit / 1073741824).toFixed(0); // é™é¢ GB

      let percent = 0;
      if (limit > 0) {
        percent = Math.min(100, Math.round((total / limit) * 100));
      }

      $("#traffic_tx").text(tx);
      $("#traffic_rx").text(rx);
      $("#traffic_total").text(total);
      $("#traffic_limit").text(limit);
      $("#traffic_percent").text(percent);

      $("#traffic_bar").css("width", percent + "%");
      $("#traffic_bar").attr("aria-valuenow", percent);
    });
  }


  function copySSHCommand() {
    const command = `sed -i 's/^#\\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config && \\
sed -i 's/^#\\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \\
/etc/init.d/ssh restart`;

    navigator.clipboard.writeText(command).then(function () {
      document.getElementById("copyStatus").style.display = "block";
    }, function (err) {
      alert("å¤åˆ¶å¤±è´¥ï¼š" + err);
    });
  }

  function ajax(options) {
    //åˆ›å»ºä¸€ä¸ªajaxå¯¹è±¡
    var xhr = new XMLHttpRequest() || new ActiveXObject("Microsoft,XMLHTTP");
    //æ•°æ®çš„å¤„ç† {a:1,b:2} a=1&b=2;
    if (typeof (options.data) != 'string') {
      var str = "";
      for (var key in options.data) {
        str += "&" + key + "=" + options.data[key];
      }
      str = str.slice(1)
    } else {
      var str = options.data;
    }

    options.dataType = options.dataType || 'json';
    if (options.type == "get") {
      var url = options.url + "?" + str;
      xhr.open("get", url);
      xhr.setRequestHeader("Authorization", "JWT {$Think.get.jwt}");
      xhr.send();
    } else if (options.type == "post") {
      xhr.open("post", options.url);
      xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
      xhr.setRequestHeader("Authorization", "JWT {$Think.get.jwt}");
      xhr.send(str)
    }
    //ç›‘å¬
    xhr.onreadystatechange = function () {
      //å½“è¯·æ±‚æˆåŠŸçš„æ—¶å€™
      if (xhr.readyState == 4 && xhr.status == 200) {
        var d = xhr.responseText;
        d = JSON.parse(d);
        //å°†è¯·æ±‚çš„æ•°æ®ä¼ é€’ç»™æˆåŠŸå›è°ƒå‡½æ•°
        options.success && options.success(d, xhr.responseXML)
      } else if (xhr.status != 200) {
        //å½“å¤±è´¥çš„æ—¶å€™å°†æœåŠ¡å™¨çš„çŠ¶æ€ä¼ é€’ç»™å¤±è´¥çš„å›è°ƒå‡½æ•°
        options.error && options.error(xhr.status);
      }
    }
  }








</script>